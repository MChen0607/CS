# 大容量存储结构

# ——磁盘

现代计算机的大量辅助存储是硬盘驱动器（HDD）和非易失性存储器（NVM）设备

SSD：固态磁盘，和下面的传统磁盘相比，更可靠，且没有移动部件。并且不需要寻道和延迟，所以速度更快；耗能更少。但是，更贵、容量大寿命也短。

## 1. 磁盘结构

- 盘片：就是圆盘，类似于唱片。两面均涂了磁性材料，对盘片进行磁性记录可以保存信息
- 磁道：盘片上同心圆，是人为划分的，一个盘片上可以有多个磁道
- 扇区：就是磁道上的部分扇形区域，一个磁道可以有多个扇区。**是最小的物理存储单位**，主要有512B/4K两种大小
- 磁头：就是直接和盘片接触的，由磁臂进行控制到指定位置。
- 磁臂：所有磁头都作为一个整体一起动（不能磁头各动各的）
- 柱面：同一磁臂位置的的磁道构成了柱面（就是一个圆柱形），柱面可以由多个盘片上的磁道构成

——一个磁盘驱动器可能有数千个柱面（有数千个磁道），一个磁道有数百个扇区

<img src="C:\Users\surface\AppData\Roaming\Typora\typora-user-images\image-20210403092417099.png" alt="image-20210403092417099" style="zoom:67%;" />

衡量单位：

1. 每分钟转数RPM：一般为5400、7200、10000...
2. 传输速率：驱动器和计算机之间的数据传输速度
3. 定位时间/随机访问时间：
   1. 寻道时间：移动磁臂要指定磁道的时间
   2. 旋转延迟：旋转磁臂要指定扇区的位置

故障：

磁头并不能直接接触磁盘表面，否则会损坏磁盘表面——磁头碰撞（不是磁头之间碰撞），这个故障不可修复，必须替换整个磁盘

磁盘可以移动。可移动磁盘一般只有一个盘片，eg：CD、DVD等。

磁盘通过IO总线连接到计算机。

**磁盘有专门的磁盘控制器**

如果要在磁盘中找数据，那么需要主机控制器向磁盘控制器发送命令 -> 磁盘控制器收到命令后操作磁盘驱动硬件，执行命令 -> 磁盘驱动器将数据加载到缓存（磁盘内部常有内置缓存，所以是从盘片到缓存之间进行数据传送）-> 从缓存到主机之间的数据传输。

磁盘如何查找：

磁盘可以看成**逻辑块的一维数组。逻辑块就是磁盘的最小传输单位**，一般为512B。——其实就是一个扇区。

扇区0就是最外面的柱面的第一个磁道的第一个扇区。映射按磁道内的扇区顺序、柱面内的磁道顺序、从外到内的柱面顺序来进行映射的。

所以按照该映射，理论上，可以将逻辑块号转换为磁盘内的柱面号 + 柱面内的轨道号 + 磁道内的扇区号。

## 2. 磁盘调度⭐

读写一个磁盘块的时间的影响因素有：

- 旋转延迟：转到指定扇区，主轴转动盘面，使得磁头移动到适当的扇区上
- 寻道时间：找到指定的磁道，制动手臂移动，使得磁头移动到适当的磁道上
- 实际的数据传输时间

其中，**寻道时间最长**，因此磁盘调度的主要目标是使磁盘的**平均寻道时间最短**。

就是给定一个请求的柱面顺序，找到合适的寻道顺序：

eg：98, 183, 37, 122, 14, 124, 65, 67。从53位置开始进行寻道

### 2.1 先来先服务FCFS

按照磁盘请求的顺序进行调度。

优点是公平和简单。缺点也很明显，因为未对寻道做任何优化，使平均寻道时间可能较长。

<img src="C:\Users\surface\AppData\Roaming\Typora\typora-user-images\image-20210403100753788.png" alt="image-20210403100753788" style="zoom:67%;" />

### 2.2 最短寻道时间优先SSTF

**优先调度与当前磁头所在磁道距离最近的磁道。**

虽然平均寻道时间比较低，但是**不够公平**。如果新到达的磁道请求总是比一个在等待的磁道请求近，那么在等待的磁道请求会一直等待下去，也就是出现饥饿现象。具体来说，两端的磁道请求更容易出现饥饿现象。

且并非最优的。

<img src="C:\Users\surface\AppData\Roaming\Typora\typora-user-images\image-20210403100908314.png" alt="image-20210403100908314" style="zoom:67%;" />

### 2.3 电梯算法SCAN

电梯总是保持一个方向运行，直到该方向没有请求为止，然后改变运行方向。

SCAN算法：**总是按一个方向来进行磁盘调度，直到到达磁盘另一端，然后改变方向。**（所以触底才反弹）如果请求正好在磁头前方加入队列，那么马上能得到执行；如果请求在磁头后方加入队列，那么需要等待反转方向之后才能移动到这边。

因为考虑了移动方向，**因此所有的磁盘请求都会被满足**，解决了 SSTF 的饥饿问题。

### 2.4 C-SCAN调度

它是SCAN的变种，C-SCAN是触底之后又回到开头重新扫描，所以一直是同一方向。

### 2.5 Look调度 和 C-Look调度

就是发现该方向上没有请求了，就改变方向，而SCAN算法是一直要触底才会反弹。

<img src="C:\Users\surface\AppData\Roaming\Typora\typora-user-images\image-20210403102315923.png" alt="image-20210403102315923" style="zoom: 50%;" />

### 2.6 如何选择磁盘调度算法

主要与应用场景相关

eg：如果是读取连续分配的文件，那么文件内容都集中在临近位置，采用SSTF较优；而如果文件分散在多个块上，会导致更多的磁盘移动，所以用SCAN算法更优。

并且存储的布局也很有关系：读取文件需要先查找目录索引才能找到该文件。而目录结构也是按照文件形式存储的。如果目录文件在第一个柱面，而文件内容在最后一个柱面，则寻道时间就是最差的。

## 3. 磁盘管理

### 3.1 磁盘格式化

新的磁盘就是一个空的结构。

刚开始初始化，需要将其分扇区，那么才能进行读写——**低级格式化/物理格式化**。

每个扇区的数据结构：头部、数据部分、尾部

头尾包含了关于该扇区的控制信息，eg：扇区号、纠错代码ECC

当写入数据时：写完后会重新计算ECC；

当读取数据时：会先计算ECC，和原来的ECC比较，如果值不一样，那么该扇区的数据已经损坏，扇区可能也坏了

ECC可以进行一定的纠错，如果只有少许数据损坏，那么可以识别损坏的位置然后改正。

并且，对于很多磁盘，在低级格式化的时候，可以指定数据区域的大小。如果采用较大扇区，那么每个磁道的扇区变少了，但是相对的头尾信息变少，数据部分变多。

如果需要让磁盘存储数据，os需要将自己的数据结构存储在磁盘上。

- **磁盘分为由柱面组成的多个分区**，每个分区都可以抽象看成一个单独的磁盘

  eg：一个分区存储代码，一个分区存储数据。

- 