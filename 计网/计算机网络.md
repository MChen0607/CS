# 计算机网络

网络：是能够将主机连接起来，就构成了一个网络

互联网：将不同的网络连接起来，所以**互联网是网络的网络**——internet

Internet：是全球范围内的internet，专有名词。

# 0. 概述

主要是介绍概念：

## ISP：互联网服务提供商

提供商可以从**互联网管理机构**获得许多 IP 地址，同时拥有通信线路以及路由器等联网设备，个人或机构向 ISP 缴纳一定的费用就可以接入互联网。

<img src="pic/isp.png" style="zoom:50%;" >

目前的互联网是一种**多层次 ISP 结构**，ISP 根据覆盖面积的大小分为**第一层 ISP、区域 ISP 和接入 ISP**。

**互联网交换点 IXP 允许两个 ISP 直接相连而不用经过第三个 ISP。**

<img src="pic/multi-isp.png" style="zoom:50%;" >

## 主机之间的通信方式

- CS（客户/服务器）：请求方是客户端，响应方是服务器，提供请求的服务
- P2P：之间对等，不区分

## 电路交换和分组交换

- 电路交换：**电话通信系统**，两个用户要通信之前需要建立一条**专用的物理链路**，在整个通信过程中始终占用该链路。由于通信的过程中不可能一直在使用传输线路，因此电路交换对线路的利用率很低，往往不到 10%。——专用的线路
- 分组交换：每个分组都有首部和尾部，包含了源地址和目的地址等控制信息，在同一个传输线路上同时传输多个分组互相不会影响，因此在同一条传输线路上允许同时传输多个分组，也就是说分组交换不需要占用传输线路。——公用的线路

**存储转发**：分组交换中用到，即某个节点收到信息后，先存储下来，然后之后将相同目的地的信息转发出去，用在邮局通信系统（现在的物流也是这样）

## 时延

总时延 = 排队时延 + 处理时延 + 传输时延 + 传播时延

1. 排队时延：在**路由器**的输入队列和输出队列中排队等待的时间，取决于**网络当前的通信量**

2. 处理时延：收到分组时进行**处理**所需要的时间，例如分析首部、从分组中提取数据、进行差错检验或查找适当的路由等

3. 传输时延：**主机或路由器**传输数据帧所需要的时间

   也就是从发送数据帧的第一个比特算起，到该帧的最后一个比特发送完毕所需的时间

   传输时延又称发送时延，即**主机or路由器将数据帧发送出去所需要的全部时间**，时延发生在机器的内部的发送器。

   注意和传播时延做区分

   $delay = \frac{l(bit)}{v(bit/s)}$

   l是帧的长度，v传输速率

4. 传播时延：电磁波在**信道**中传播所需要花费的时间，电磁波的传播速度接近光速

   $delay=\frac{l(m)}{v(m/s)}$

   l是信道长度，v是电磁波在信道上的传播速度

   时延发生在机器外部的传输信道媒体。

   电磁波在自由空间的传播速率是光速，即3.0×105km/s。电磁波在网络传输媒体中的传播速率比在自由空间要略低一些：在铜线电缆中的传播速率约为2.3×105km/s，在光纤中的传播速率约为2.0×105km/s。例如，1000km长的光纤线路产生的传播时延大约为5ms。【摘自计算机网络1.6.1】

## 网络体系结构

<img src="pic/osi.jpg" style="zoom: 80%;" >

### 5层模型（最常见）

从上到下：

1. 应用层

   为**特定应用程序**提供数据传输服务，例如 HTTP、DNS 等协议。数据单位为**报文**。

2. 传输层

   为**进程**提供通用数据传输服务

   由于应用层协议很多，定义通用的传输层协议就可以支持不断增多的应用层协议。

   主要有以下的两种协议：

   - **传输控制协议 TCP**，提供面向连接、可靠的数据传输服务，数据单位为**报文段**；
   - **用户数据报协议 UDP**，提供无连接、尽最大努力的数据传输服务，数据单位为**用户数据报**

   **TCP 主要提供完整性服务，UDP 主要提供及时性服务。**

3. 网络层

   为**主机**提供数据传输服务。

   网络层把传输层传递下来的报文段或者用户数据报封装成**分组**。

4. 数据链路层

   主机之间的数据传输，需要在一段段链路上传送，链路层协议就是为**同一链路的主机提供数据传输服务**，即在同一个链路两端的结点之间进行传输

   数据链路层把网络层传下来的分组封装成**帧**。

5. 物理层

   考虑的是怎样在**传输媒体**上传输数据比特流，而不是指具体的传输媒体。物理层的作用是**尽可能屏蔽传输媒体和通信手段的差异，使数据链路层感觉不到这些差异。**

   即对上（数据链路层）提供统一的传输数据接口，虽然物理层会采用不同的传输媒体和通信手段

   请注意，传递信息所利用的一些**物理媒体并不在物理层协议之内而是在物理层协议的下面**，如双绞线、同轴电缆、光缆、无线信道等——也有人把物理媒体当作第0层。

   类似于：驱动和物理设备的关系

| 层名       | 服务对象           | 数据单位 |
| ---------- | ------------------ | -------- |
| 应用层     | 特定的应用程序     | 报文     |
| 传输层     | 进程（通用服务）   | 数据报   |
| 网络层     | 主机               | 分组     |
| 数据链路层 | 同一链路的两个节点 | 帧       |
| 物理层     | 传输媒体驱动       | 数据流   |

### 7层OSI模型

增加了两层：

- 表示层：数据压缩、加密以及数据描述。应用程序不必关心在各台主机中数据内部格式不同的问题。
- 会话层：建立及管理会话

五层协议没有表示层和会话层，而是将这些功能留给应用程序开发者处理。

### TCP/IP模型

是4层模型，将最下面的数据链路层和物理层合并为网络接口层

TCP/IP 体系结构不严格遵循 OSI 分层概念，应用层可能会直接使用 IP 层或者网络接口层。

### 数据在各层之间的传递

在向下的过程中，需要添加下层协议所需要的首部或者尾部，而在向上的过程中不断拆开首部和尾部。

**路由器只有下面三层协议**，因为路由器位于网络核心中，不需要为进程或者应用程序提供服务，因此也就不需要传输层和应用层。

# 1. 物理层

## 通信方式

根据信息在传输线上的传送方向，分为以下三种通信方式：

- 单工通信：单向传输

  eg：广播、电视

- 半双工通信：双向交替传输

  即通信的双方都可以发送信息和接收，但不能双方同时发送/接收。这种通信方式是一方发送另一方接收，过一段时间后再反过来。

- 全双工通信：双向同时传输

## 带通调制

模拟信号是连续的信号，数字信号是离散的信号。带通调制把数字信号转换为模拟信号。

# 2. 链路层

链路层的最重要的内容

- 数据链路层的点对点信道和广播信道的特点，以及这两种信道所使用的协议（PPP协议以及CSMA/CD协议）的特点
- 数据链路层的三个基本技术：封装成帧、透明传输和差错检测
-  以太网MAC层的硬件地址
- 适配器、转发器、集线器、网桥、以太网交换机的作用以及使用场合。

## 2.1 基本技术

基本技术包括：封装成帧、透明传输、差错检测

### 封装成帧

**将网络层传下来的分组添加首部和尾部，用于标记帧的开始和结束**，即在分组外面再套一层，主要用来分界

<img src="pic/frame.png" style="zoom: 80%;" >



### 透明传输

主要是分界需要用到一些字符，而该字符如果在数据部分出现，那么会引起歧义（例如提前断帧），所以需要将这些字符进行处理，从而将整个数据部分当作透明的存在

（有点像玻璃窗，窗边的黑框表示分界，而中间的数据部分就是透明的玻璃，如果数据部分存在和分界一样的内容，需要处理，从而将这些歧义的部分也当作透明）

官方的定义：帧使用首部和尾部进行定界，如果帧的数据部分含有和首部尾部相同的内容，那么帧的开始和结束位置就会被错误的判定。需要在**数据部分出现首部尾部相同的内容前面插入转义字符**。如果数据部分出现转义字符，那么就在**转义字符前面再加个转义字符**。在接收端进行处理之后可以还原出原始数据。这个过程透明传输的内容是转义字符，用户察觉不到转义字符的存在。

——该方法被称为**字节填充**

<img src="pic/stuffing.png" style="zoom: 67%;" >

（why在转义字符之前再加一个转义字符，

​    $\because$ 接收端的数据链路层会把数据送往网络层之前删除这个插入的转义字符，那么本来就是该内容的被删除了，而增加了一个转义字符，那么只删除前面一个，还能还原原样）

### 差错检测

目前数据链路层广泛使用了循环冗余检验（CRC）来检查比特差错。

## 2.2 信道

### 信道分类

- 广播信道：一对多通信，一个节点发送的数据能够被广播信道上所有的节点接收到。

  所有的节点都在同一个广播信道上发送数据，因此需要有专门的控制方法进行协调，避免发生冲突（冲突也叫碰撞）。

  控制的方法有两种：信道复用技术，**CSMA/CD 协议**

- 点对点信道：一对一通信

  不会发生碰撞，比较简单，用**PPP协议**进行控制

### 信道复用（广播信道）

背景：同一个信道，可能有很多设备都需要使用

- 频分复用：所有主机在相同时间**占用不同的频率**带宽资源——同一时刻有多个信息在传输
- 时分复用：所有主机在**不同时间占用**相同的频率带宽资源——同一时刻只有一个信息在传输

——这两种通信方式，**在通信的过程中主机会一直占用一部分信道资源**。但是由于计算机数据的突发性质，通信过程没必要一直占用信道资源而不让出给其它用户使用，因此这两种方式对信道的利用率都不高。

- 统计时分复用：不固定每个用户在时分复用帧中的位置，只要有数据就集中起来组成统计时分复用帧然后发送。

- 波分复用：采用不同的波长来光来传递不同的信息

- 码分复用：利用正交的性质

  规则是：

  - 为每个用户分配 m bit 的码片，并且所有的码片正交，即对于任意两个码片 $\vec S$ 和 $\vec T$ ，满足：$\frac{1}{m} \vec S \cdot \vec T=0$
  - 在拥有该码片的用户发送比特 1 时就发送该码片，发送比特 0 时就发送该码片的反码

  举例：取 m=8，设 $\vec S$ 的码片为 00011011

  在计算时将 00011011 记作 (-1 -1 -1 +1 +1 -1 +1 +1)，可以得到：

  $\frac{1}{m} \vec S \cdot \vec {S'}=-1$

  $\frac{1}{m} \vec S \cdot \vec S=1$

  所以，当接收端使用码片对接收到的数据进行内积运算时，结果为 0 的是其它用户发送的数据，结果为 1 的是用户发送的比特 1，结果为 -1 的是用户发送的比特 0。

  ——即通过内积的计算，排除非自己接收的数据，接收自己的数据0、1数据串

  码分复用需要发送的数据量为原先的 m 倍。

### CSMA/CD协议（广播信道）

载波监听多点接入 / 碰撞检测。

- 多点接入：**总线型网络**，主机以多点接入的方式连接在一根总线上（在总线上，同一时间只能有一个主机在发送数据，多个点发送的数据会产生干扰）

- 载波监听：即**检测信道，每个节点不论在何种状态下必须不停检测信道**

  发送前检测，为了获得发送权。如果发送前检测到有其他站在发送就暂停发送；如果没有发送就发送

- 碰撞检测：**边发送边监听**（当几个站同时在总线上发送数据时，总线上的信号电压变化幅度将会增大（互相叠加）。当适配器检测到的信号电压变化幅度超过一定的门限值时，就认为总线上至少有两个站同时在发送数据，表明产生了碰撞）

  一旦发现碰撞，停止发送，等待一段时间后才再次发送。

  why：在发送前确认没有在发送，而发送时还是会发生碰撞

  $\because$ 可能存在同时检测，同时发现空闲，同时发送的问题；还有，电磁波发送存在一定的延时，需要隔一段时间才能检测到（电磁波在1km电缆的传播时延约为5 μs）

单程端到端的传播时延为 $\tau$，最先发送的站点最多经过 $2\tau$ 就可以知道是否发生了碰撞，称 **$2\tau$为争用期（碰撞窗口）** 。只有经过争用期之后还没有检测到碰撞，才能肯定这次发送不会发生碰撞。——最大的极端就是如下：

<img src="pic/clush.jpg" style="zoom: 80%;" >

使用CSMA/CD协议时，一个站不可能同时进行发送和接收（但必须边发送边监听信道）。因此使用**CSMA/CD协议的以太网只能按照半双工通信**

当发生碰撞时，站点要停止发送，等待一段时间再发送。这个时间采用 **截断二进制指数退避算法** 来确定。从离散的整数集合 {0, 1, .., (2k-1)} ($k=min(重传次数, 10)$)中随机取出一个数，记作 r，然后取 r 倍的争用期作为重传等待时间。如果重传16次仍不成功，就丢弃该帧向上层报告。

### PPP协议（点对点信道）

因特网用户通常都要连接到某个ISP才能接入到因特网。**PPP协议就是用户计算机和ISP进行通信时所使用的数据链路层协议**。

PPP 的帧格式：

- F 字段为**帧的定界符**，帧的开头和结尾都有，如果出现连续两个定界符，是一个空帧，直接丢弃
- A 和 C 字段暂时没有意义
- 2字节的协议字段：协议字段为0x0021时，PPP帧的信息字段就是IP数据报；0xC021,则信息字段是PPP链路控制协议LCP的数据...
- FCS 字段是使用 CRC 的检验序列
- 内容部分的长度不超过 **1500字节**

<img src="pic/ppp.png" style="zoom: 67%;" >

## 2.3 MAC地址（硬件/物理地址）

MAC 地址是链路层地址，长度为 6 字节（48 位），用于**唯一标识网络适配器（网卡）**，在网卡出厂时就写在ROM中了。

一台主机拥有多少个网络适配器就有多少个 MAC 地址。例如笔记本电脑普遍存在无线网络适配器和有线网络适配器，因此就有两个 MAC 地址。

**网卡有过滤功能**：每收到一个MAC帧就先用硬件检查MAC帧中的目的地址。如果是发往本站的帧则收下，然后再进行其他的处理。否则就将此帧丢弃，不再进行其他的处理

## 2.4 链路层设备



为了通信的简便，以太网采取了以下两种措施：

- **无连接**的工作方式，即**不必先建立连接就可以直接发送数据**。适配器对发送的**数据帧不进行编号，也不要求对方发回确认**（TCP的要求编号 + ACK确认）。这样做可以使以太网工作起来非常简单，而**局域网信道的质量很好**，因通信质量不好产生差错的概率是很小的。因此，以太网提供的服务是**尽最大努力的交付，即不可靠的交付**。当目的站收到有差错的数据帧时（例如，用CRC查出有差错），就把帧丢弃，其他什么也不做。**对有差错帧是否需要重传则由高层来决定**。例如，如果高层使用TCP协议，那么TCP就会发现丢失了一些数据。于是经过一定的时间后，TCP就把这些数据重新传递给以太网进行重传。但以太网并不知道这是重传帧，而是当作新的数据帧来发送。
- 用曼彻斯特编码的信号。普通0/1信号，当出现一长串的连1或连0时，接收端就无法从收到的比特流中提取位同步（即比特同步）信号。码元1是在前一个间隔为低电压而后一个间隔为高电压（01）。码元0则正好相反（10），可以反着来。差分曼彻斯特码是：0不变，遇到1变化。但是它所占的**频带宽度比原始的基带信号增加了一倍**



# 3. 网络层

## 3.1 概述

命名：由于网络层的核心是网际协议IP，所以又称**网际层、IP层**

整个互联网的核心

网络层：**主要是将多个网络通过路由器互联成为一个互联网**。

网络层向上只提供简单灵活的、**无连接的**、**尽最大努力交互**的数据报服务。

- 无连接：发送分组时不需要先建立连接。每一个分组（也就是IP数据报）独立发送，与其前后的分组无关（不进行编号）

- 尽最大努力交互：即不可靠的，所传送的分组可能出错、丢失、重复和失序（即不按序到达终点），当然也不保证分组交付的时限

  （如果通信需要是可靠的，那么就由网络的主机中的传输层负责）

**网际协议IP**是TCP/IP体系中两个最主要的协议之一

与 IP 协议配套使用的还有三个协议：

- **地址解析协议 ARP**（Address Resolution Protocol），还有对应的逆地址解析协议RARP（已经淘汰了，DHCP协议已经包含了RARP协议的功能）
- **网际控制报文协议 ICMP**（Internet Control Message Protocol）
- **网际组管理协议 IGMP**（Internet Group Management Protocol）

4个协议之间的关系：

IP需要用到ARP，ICMP和IGMP需要用到IP

<img src="pic/IP.jpg" style="zoom: 80%;" >

网络是多种多样的，TCP/IP体系在网络互连上采用的做法是在**网络层（即IP层）采用了标准化协议**，但相互连接的网络则可以是异构的。参加互连的计算机网络都使用相同的IP协议，因此可以把互连以后的网络看成一个**虚拟互连网络**，即逻辑互连网络：互连起来的各种物理网络的存在异构性，但是利用IP协议就可以使这些性能各异的网络在网络层上看起来好像是一个统一的网络

## 3.2 IP 数据报格式

<img src="pic/IP_mes.jpg" style="zoom:80%;" >

首部的前一部分是固定长度，共**20字节**，是所有IP数据报必须具有的。在首部的固定部分的后面是一些可选字段，其长度是可变的

- **版本** : 有 4（IPv4）和 6（IPv6）两个值；

- **首部长度** : 占 4 位，因此最大值为 15。值为 1 表示的是 1 个 32 位字的长度，也就是 4 字节。因为固定部分长度为 20 字节，因此该值最小为 5。首部最大为60字节（希望用户尽量减少开销）。如果可选字段的**长度不是 4 字节的整数倍，就用尾部的填充部分来填充**。

- **区分服务** : 用来获得更好的服务，一般情况下不使用。

- **总长度** : 包括首部长度和数据部分长度。（如果存在分片，也是每个分片的IP数据报的总长度）

- **生存时间** ：TTL，它的存在是为了防止无法交付的数据报在互联网中不断兜圈子。**以路由器跳数为单位**，当 TTL 为 0 时就丢弃数据报。

- **协议** ：指出携带的数据应该上交给哪个协议进行处理，例如 ICMP、TCP、UDP 等。

- **首部检验和** ：因为数据报每经过一个路由器，都要重新计算检验和，因此**检验和不包含数据部分**可以减少计算的工作量。

  （先把IP数据报首部划分为许多16位字的序列，并把检验和字段置零。用反码算术运算把所有16位字相加后，将得到的和的反码写入检验和字段）

- **标识** : 在数据报长度过长从而发生分片的情况下，**相同数据报的不同分片具有相同的标识符**。

- **片偏移** : 和标识符一起，用于发生分片的情况。该片在原分组中的相对位置。**片偏移的单位为 8 字节**。（所以需要以8字节为单位进行分片，最后一个分片可以不足8字节）

-  **标志**(flag) 占3位，但目前只有两位有意义。

  - 标志字段中的最低位记为MF (More Fragment)。MF = 1即表示后面“还有分片”的数据报。MF = 0表示这已是若干数据报片中的最后一个
  - 标志字段中间的一位记为DF (Don't Fragment)，意思是“不能分片”。只有当DF = 0时才允许分片。

在IP层下面的每一种数据链路层协议都规定了一个数据帧中的数据字段的最大长度，这称为**最大传送单元MTU** (Maximum Transfer Unit)。当一个IP数据报封装成链路层的帧时，此数据报的总长度（即首部加上数据部分）一定不能超过下面的数据链路层所规定的MTU值。最常用的以太网就规定其**MTU值是1500字节**。若所传送的数据报长度超过数据链路层的MTU值，就必须把过长的数据报进行分片处理。每个分片都有首部

虽然使用尽可能长的IP数据报会使传输效率提高（因为每一个IP数据报中首部长度占数据报总长度的比例就会小些），但数据报短些也有好处。每一个IP数据报越短，路由器转发的速度就越快

**IPv6就把IP数据报的首部长度做成固定的**

## 3.3 IP地址分类

IP 地址的编址方式经历了三个历史阶段：

- 分类
- 子网划分
- 无分类

### 0. IP地址和MAC地址的区分

层次的角度看：

- 物理地址是数据链路层和物理层使用的地址
- IP地址是网络层和以上各层使用的地址，是一种**逻辑地址**

使用IP地址的IP数据报一旦交给了数据链路层，就被封装成MAC帧了。**MAC帧在传送时使用的源地址和目的地址都是硬件地址**

连接在通信链路上的设备（主机或路由器）在接收MAC帧时，其根据是MAC帧首部中的硬件地址。在**数据链路层看不见隐藏在MAC帧的数据中的IP地址**。只有在剥去MAC帧的首部和尾部后把MAC层的数据上交给网络层后，**网络层能在IP数据报的首部中找到源IP地址和目的IP地址。**

### 1. 分类

IP地址 = 网络号 + 主机号，其中不同分类具有不同的网络号长度，并且是固定的。

网络号：标志主机连接到的网络，要求在整个互联网范围内是唯一的

主机号：要求在该网络中是唯一的

——该IP地址在整个因特网范围内是唯一的。

<img src="pic/class_net.jpg">

*A类、B类和C类地址都是单播地址（一对一通信）*

*D类地址用于多播（一对多通信）*

从IP地址的结构来看，IP地址并不仅仅指明一个主机，而是还指明了主机所连接到的网络。

**特殊的保留IP：**

| 类别 | 网络号数据   | 网络范围 | 主机数       |
| ---- | ------------ | -------- | ------------ |
| A    | $2^7-2$      | 0~127    | $2^{24} - 2$ |
| B    | $2^{14} - 2$ | 128~191  | $2^{16} - 2$ |
| C    | $2^{21}-1$   | 192~224  | $2^8-2$      |

A类中不能分配的网络号：

- 0。**网络号字段为全0的IP地址是个保留地址，意思是“本网络”**
- 127（即01111111）。保留作为本地软件**环回测试**

B类中不能分配的网络号：

- 网络地址128.0.0.0是不指派的，可以指派的B类最小网络号是128.1.0.0

C类

- 网络地址192.0.0.0也是不指派的，可以指派的C类最小网络号是192.0.1.0

主机号都有2个不能分配：

- 全0的主机号字段表示该IP地址是“本主机”所连接到的**单个网络地址**
- 全1表示“所有的(all)”，因此全1的主机号字段表示该网络上的**所有主机**

特点：

- IP地址管理机构在分配IP地址时只分配网络号，主机号给单位自行分配
- 路由器仅根据目的主机所连接的网络号来转发分组，减小了路由表所占的存储空间以及查找路由表的时间

——很少使用了

### 2. 子网划分

通过在主机号字段中拿一部分作为子网号，把两级 IP 地址划分为三级 IP 地址。

IP 地址 = 网络号  + **子网号** + 主机号

不使用第一种分类的原因：

- IP地址空间的利用率有时很低，对于A类网络，主机有时候没有那么多，造成大量浪费
- 给每一个物理网络分配一个网络号会使路由表变得太大，导致网络性能变坏
- 两级IP地址不够灵活，必须要先申请到网络号才能将网络接入

特点：**划分子网只是把IP地址的主机号这部分进行再划分，而不改变IP地址原来的网络号**。

凡是从其他网络发送给本单位某个主机的IP数据报，仍然是根据IP数据报的目的网络号找到连接在本单位网络上的路由器。但此路由器在收到IP数据报后，再按目的网络号和**子网号找到目的子网**，把IP数据报交付目的主机

要使用子网，必须配置**子网掩码**——**一个网络或一个子网的重要属性**

IP 地址 与 子网掩码 = 网络地址，并且根据IP，能够知道网络所属的类，并且能够根据掩码知道子网位数和子网号

eg：一个 B 类地址的默认子网掩码为 255.255.0.0（前16位），如果 B 类地址的子网占两个比特（说明最多有4个子网），那么子网掩码为 11111111 11111111 11000000 00000000，也就是 255.255.192.0。

145.13.3.10的主机所在的网络进行子网划分，它本来是B类的网络（128~192之间的），将主机号的8位作为子网号，那么当前IP所在的子网号为3的网络的**网络地址是145.13.3.0**（既不是原来两级IP地址的网络地址145.13.0.0，也不是简单的子网号3，网络地址 = 网络号 + 子网号+补0）

注意：外部网络看不到子网的存在，对外还是表现为一个网络

划分子网增加了灵活性，但却减少了能够连接在网络上的主机总数

在不划分子网时，既然没有子网，为什么还要使用子网掩码？——为了更便于查找路由表

### 3. 无分类编址CIDR

特点：

- 消除了传统 A 类、B 类和 C 类地址以及划分子网的概念使用网络前缀和主机号来对 IP 地址进行编码，网络前缀的长度可以根据需要变化。
-  CIDR把**网络前缀都相同**的连续的IP地址组成一个“CIDR地址块”。

IP 地址 =  网络前缀号 + 主机号

CIDR：使用“斜线记法"，IP地址后面加上斜线“/”，然后写上网络前缀所占的位数，eg：192.168.0.0/16，表示前16位为网络号，也表示子网掩码的1的个数，CIDR 的地址掩码可以继续称为子网掩码

CIDR仍然在本单位内根据需要划分出一些子网

一个 CIDR 地址块中有很多地址，一个 CIDR 表示的网络就可以表示原来的很多个网络，并且在路由表中只需要一个路由就可以代替原来的多个路由，减少了路由表项的数量。把这种通过使用网络前缀来减少路由表项的方式称为**路由聚合**，也称为 **构成超网** 。

<img src="pic/web_collect.png" style="zoom:50%;" >

——就是将路由表中的路由表项能合并的尽量合并：——最长前缀匹配即可

eg：172.18.129.0/24、172.18.130.0/24、172.18.132.0/24、172.18.133.0/24，如果这四个进行路由汇聚，得到172.18.128.0/21，那么表项从4个变成1个。

在路由表中的项目由“网络前缀”和“下一跳地址”组成，在查找时可能会得到不止一个匹配结果，应当采用**最长前缀匹配**来确定应该匹配哪一个。前缀匹配越多，那么网络越具体

eg：其目的IP地址为D = 206.0.71.130，路由表中：206.0.68.0/22和206.0.71.128/25，均能匹配上，那么选择后者，因为后者匹配的数位25，所以更为具体

CIDR优势：

- 可以更加有效地分配IPv4的地址空间，可根据客户的需要分配适当大小的CIDR地址块，而不用按照8/16/24来划分网络号，而可以在1~31位网络号中随意分配

## 3.4 地址解析协议ARP

### 1. 概念

问题引出：已经知道了一个机器的IP地址，需要找出其相应的硬件地址（RARP，已知硬件地址的主机能够通过RARP协议找出其IP地址）

原因：实际传输过程中，还是要在**实际网络的链路上传送数据帧**时，最终还是必须使用该网络的硬件地址。但IP地址和下面的网络的硬件地址之间由于格式不同而不存在简单的映射关系（IP地址有32位，而局域网的硬件地址是48位），并且在一个网络上可能经常会有新的主机加入进来，或撤走一些主机。更换网络适配器也会使主机的硬件地址改变。

——即网络层实现主机之间的通信，而链路层实现具体每段链路之间的通信。因此在通信过程中，IP 数据报的源地址和目的地址始终不变，而 MAC 地址随着链路的改变而改变，所以报文中需要获得MAC地址

<img src="pic/APR_reason.jpg" style="zoom:67%;" >

每个主机都有一个 ARP 高速缓存，里面有**本局域网**上的各主机和路由器的 IP 地址到 MAC 地址的映射表，并且这个映射表还经常动态更新（新增或超时删除）

流程：

- 当主机A要向本局域网上的某个主机B发送IP数据报时，就先在其ARP高速缓存中查看有无主机B的IP地址

  如果在ARP Cache中存在IP地址（即存在对应的映射），那么直接获取MAC地址，封装成MAC帧，然后发送即可

- 如果没有，可能是主机B才入网，也可能是主机A的ARP Cache还是空的

  - ARP进程在本局域网上**广播发送**一个ARP请求分组

    主要内容是：“我的IP地址是209.0.0.5，硬件地址是00-00-C0-15-AD-18。我想知道IP地址为209.0.0.6的主机的硬件地址

  - 所有主机上运行的ARP进程都收到此ARP请求分组

  - 主机B的IP地址与ARP请求分组中要查询的IP地址一致，就收下这个ARP请求分组，并向主机A发送ARP响应分组

    主要内容是：“我的IP地址是209.0.0.6，我的硬件地址是08-00-2B-00-EE-0A

  - 主机A收到主机B的ARP响应分组后，就在其ARP高速缓存中写入主机B的IP地址到硬件地址的映射。

    （并且，当主机B收到A的ARP请求分组时，也会把A的这一地址映射写入主机B自己的ARP高速缓存中，所以A的请求分组需要带上自己的IP地址和MAC地址，方便别的主机进行cache存储）

——ARP请求分组是广播发送的，但ARP响应分组是普通的单播

<img src="pic/ARP.png" style="zoom:67%;" >

ARP Cache的生存时间：每一个映射地址项目都设置生存时间，凡超过生存时间的项目就从高速缓存中删除掉

### 2. 注意

ARP是解决**同一个局域网**上的主机或路由器的IP地址和硬件地址的映射问题，跨局域网ARP无法解析MAC地址，也不需要MAC地址。不同局域网需要通过路由器（跨局域网的传输时，通过路由器，而路由器存在不同的IP地址，所以源IP和目的IP也会发生变化）

从IP地址到硬件地址的解析是自动进行的，主机的用户对这种地址解析过程是不知道的

典型的4种利用ARP的场景：

<img src="pic/4ARP.jpg">

（1）发送方是主机（如H1），要把IP数据报发送到**同一个网络**上的另一个主机（如H2）。这时H1发送ARP请求分组（在网1上广播），找到目的主机H2的硬件地址。——直接使用

（2）发送方是主机（如H1），要把IP数据报发送到**另一个网络**上的一个主机（如H3或H4）。这时H1发送ARP请求分组（在网1上广播），找到网1上的一个**路由器**R1的硬件地址。剩下的工作由路由器R1来完成。

（3）发送方是路由器（如R1），要把IP数据报转发到与R1连接在同一个网络（网2）上的主机（如H3）。这时R1发送ARP请求分组（在网2上广播），找到目的主机H3的硬件地址

（4）发送方是路由器（如R1），要把IP数据报转发到网3上的一个主机（如H4）。H4与R1不是连接在同一个网络上。这时R1发送ARP请求分组（在网2上广播），找到连接在网2上的一个路由器R2的硬件地址。剩下的工作由这个路由器R2来完成

why：不直接使用硬件地址进行通信，而是要使用抽象的IP地址并调用ARP来寻找出相应的硬件地址呢？

存在着各式各样的网络，它们使用不同的硬件地址。要使这些异构网络能够互相通信就必须进行非常复杂的硬件地址转换工作。而IP地址是统一的，对于用户来说只需关注IP地址，MAC地址转换工作交给ARP进程即可

## 3.5 网际控制报文协议 ICMP

ICMP 是为了更有效地转发 IP 数据报和提高交付成功的机会。它封装在 IP 数据报中，但是不属于高层协议：ICMP报文 +IP首部，然后发送出去

主要功能：报告差错情况和提供有关异常情况的报告

ICMP 报文分为**差错报告报文**和**询问报文**。

<img src="pic/ICMP.png" style="zoom:67%;" >

（时间超过：当路由器收到生存时间为零的数据报时，除丢弃该数据报外，还要向源点发送时间超过报文。当终点在预先规定的时间内不能收到一个数据报的全部数据报片时，就把已收到的数据报片都丢弃，并向源点发送时间超过报文。）

（改变路由（重定向） 路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器（可通过更好的路由））

（回送请求和回答：测试目的站是否可达以及了解其有关状态）

（时间戳请求与回答：可用来进行时钟同步和测量时间。）

ICMP差错报告报文中的数据字段都具有同样的格式：把收到的需要进行差错报告的**IP数据报的首部**和**数据字段的前8个字节**（这些信息对源点通知高层协议是有用的）提取出来，作为ICMP报文的数据字段。再加上相应的ICMP差错报告报文的前8个字节，就构成了ICMP差错报告报文

<img src="pic/ICMP_msg.jpg" style="zoom: 80%;" >

特殊情况：

不应发送ICMP差错报告报文的几种情况

- 对ICMP差错报告报文不再发送ICMP差错报告报文
- 对第一个分片的数据报片的所有后续数据报片都不发送ICMP差错报告报文
- 对具有多播地址的数据报都不发送ICMP差错报告报文
- 对具有特殊地址（如127.0.0.0或0.0.0.0）的数据报不发送ICMP差错报告报文。

### 1. Ping（分组网间探测）

Ping 是 ICMP 的一个重要应用，主要用来**测试两台主机之间的连通性**。

PING是**应用层直接使用网络层ICMP**的一个例子。它没有通过运输层的TCP或UDP

原理：PING使用了ICMP回送请求与回送回答报文，通过向目的主机发送 ICMP Echo 请求报文，目的主机收到之后会发送 Echo 回答报文。**Ping 会根据时间和成功响应的次数估算出数据包往返时间以及丢包率。**

### 2. Traceroute

Traceroute 是 ICMP 的另一个应用，用来**跟踪一个分组从源点到终点的路径**。

Traceroute 发送的 IP 数据报封装的是无法交付的 UDP 用户数据报，并由目的主机发送终点不可达差错报告报文。

- 源主机向目的主机发送一连串的 IP 数据报。第一个数据报 P1 的生存时间 TTL 设置为 1，当 P1 到达路径上的第一个路由器 R1 时，R1 收下它并把 TTL 减 1，此时 TTL 等于 0，R1 就把 P1 丢弃，并向源主机发送一个 **ICMP 时间超过差错报告报文**；
- 源主机接着发送第二个数据报 P2，并把 TTL 设置为 2。P2 先到达 R1，R1 收下后把 TTL 减 1 再转发给 R2，R2 收下后也把 TTL 减 1，由于此时 TTL 等于 0，R2 就丢弃 P2，并向源主机发送一个 ICMP 时间超过差错报文。
- 不断执行这样的步骤，直到最后一个数据报**刚刚到达目的主机**，主机不转发数据报，也不把 TTL 值减 1。但是因为数据报封装的是无法交付的 UDP，因此目的主机要向源主机发送 **ICMP 终点不可达差错报告报文**。
- 之后**源主机知道了到达目的主机所经过的路由器 IP 地址以及到达每个路由器的往返时间**。

## 3.6 路由选择协议

路由选择协议都是自适应的，能随着网络通信量和拓扑结构的变化而自适应地进行调整。

互联网可以划分为许多较小的自治系统 AS，一个AS对其他AS表现出的是一个单一的和一致的路由选择策略（该AS选择的路由协议是一致的），eg：一个大的ISP就是一个AS

可以把路由选择协议划分为两大类：

- 内部网关协议IGP：AS内部的路由选择：RIP 和 OSPF
- 外部网关协议EGP：AS间的路由选择：BGP

（要弄清以下三个要点，即和哪些路由器交换信息？交换什么信息？在什么时候交换信息？）

### 1. 路由信息协议RIP：IGP

RIP 是一种**基于距离向量的路由选择协议**。距离是指跳数，直接相连的路由器跳数为 1。跳数最多为 15，**>15 表示不可达**。

特点：

- 仅和相邻路由器交换自己的路由表
- 换的信息是当前本路由器所知道的全部信息，即自己的路由表
- 按固定的时间间隔

经过若干次交换之后，所有路由器最终会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器地址。

RIP协议可以收敛，并且过程也较快

距离向量算法：——找出到每个目的网络的**最短距离**

- 对地址为 X 的相邻路由器发来的 RIP 报文，先修改报文中的所有项目，把下一跳字段中的地址改为 X，并把所有的距离字段加 1；
- 对修改后的 RIP 报文中的每一个项目，进行以下步骤：
  - 若原来的路由表中没有目的网络 N，则把该项目添加到路由表中；
  - 否则（在路由表中有目的网络N）：若下一跳路由器地址是 X，则把收到的项目**替换**原来路由表中的项目（因为网络状态在发生改变）；否则（即这个项目是：到目的网络N，但下一跳路由器不是X）：若收到的项目中的距离 d 小于路由表中的距离，则进行更新（例如原始路由表项为 Net2, 5, P，新表项为 Net2, 4, X，则更新）；否则什么也不做。
- 若 3 分钟还没有收到相邻路由器的更新路由表，则把该相邻路由器标为不可达，即把距离置为 16。

RIP 协议优点：实现简单，开销小

 RIP 协议缺点：

- 能使用的最大距离为 15，**限制了网络的规模**
- 当网络出现故障时，要经过**比较长的时间才能将此消息传送到所有路由器**。

——RIP协议的这一特点叫做：**好消息传播得快，而坏消息传播得慢**

<img src="pic/RIP.jpg" style="zoom:80%;" >

### 2. 开放最短路径优先OSPF：IGP

开放最短路径优先 OSPF，是为了克服 RIP 的缺点而开发出来的。

开放表示 OSPF 不受某一家厂商控制，而是公开发表的；最短路径优先表示使用了 Dijkstra 提出的最短路径算法 SPF。

OSPF 具有以下特点：

- 向本自治系统中的所有路由器发送信息，这种方法是**洪泛法**。
- 发送的信息就是**与相邻路由器的链路状态**，链路状态包括与哪些路由器相连以及链路的度量，度量用费用、距离、时延、带宽等来表示。这个是路由器的部分信息。
- 只有当链路状态发生变化时，路由器才会发送信息。

所有路由器都具有**全网的拓扑结构图**（RIP是走一步看一步），并且是一致的（RIP中每个路由器的路由表都是独有的）。相比于 RIP，OSPF 的更新过程收敛的很快。

OSPF将一个自治系统再划分为若干个更小的范围，叫作区域，那么能表示的范围更大，并且使用的泛洪法也会减少了整个网络上的通信量。在一个区域内部的路由器只知道本区域的完整网络拓扑，而不知道其他区域的网络拓扑的情况。OSPF使用**层次结构的区域划分**。在上层的区域叫作主干区域（主要是连通其他在下层的区域），从其他区域来的信息都由**区域边界路由器**进行概括。在主干区域内还要有一个路由器专门和本自治系统外的其他自治系统交换路由信息。这样的路由器叫作自治系统边界路由器

OSPF不用UDP而是直接用IP数据报传送，RIP是用UDP进行传送

### 3. 边界网关协议BGP：EGP

内部网关协议（如RIP或OSPF）主要是设法使数据报在一个AS中**尽可能有效地**从源站传送到目的站

AS 之间的路由选择很困难，主要是由于：

- 互联网规模很大：必须对任何有效的IP地址都能在路由表中找到匹配的目的网络，那么路由表将会十分庞大，RIP和OSPF都不适合了
- 各个 AS 内部使用不同的路由选择协议，无法准确定义路径的度量；
- AS 之间的路由选择必须考虑有关的策略，比如有些 AS 不愿意让其它 AS 经过。

BGP 只能寻找一条比较好的路由，而不是最佳路由。

**每个 AS 都必须配置 BGP 发言人**，通过在两个相邻 BGP 发言人之间**建立 TCP 连接**来交换路由信息。

<img src="pic/BGP.png" style="zoom:67%;" >



## 3.7 虚拟专用网VPN

由于 IP 地址的紧缺，一个机构能申请到的 IP 地址数往往远小于本机构所拥有的主机数，并且一个机构并不需要把所有的主机接入到外部的互联网中。**机构内的计算机可以使用仅在本机构有效的 IP 地址（专用地址）**，而不需要给所有计算机申请全球唯一的IP地址（全球地址）

有三个专用地址块：

- 10.0.0.0 ~ 10.255.255.255（10.0.0.0/8）
- 172.16.0.0 ~ 172.31.255.255（172.16.0.0/12）
- 192.168.0.0 ~ 192.168.255.255（192.168.0.0/16）

专用地址只能用作本地地址而不能用作全球地址，又称可重用地址（世界上存在很多该重复的IP地址）。在因特网中的所有路由器，对目的地址是专用地址的数据报**一律不进行转发**。

VPN 使用公用的互联网作为本机构各专用网之间的通信载体。

- 专用：指机构内的主机只与本机构内的其它主机通信；
- 虚拟指好像是，而实际上并不是，它有经过公用的互联网进行专用网不同网点间的通信。由于要经过公用网，所以**所有通过因特网传送的数据都必须加密**

一个机构要构建自己的VPN就必须为它的每一个场所购买专门的硬件和软件，并进行配置，使**每一个场所的VPN系统都知道其他场所的地址**（即路由器需要能够知道其他场所的地址，那么能够通过路由器进行IP目的地址和源地址的包装，并发送出去）

下图中，场所 A 和 B 的通信经过互联网,如果场所 A 的主机 X 要和另一个场所 B 的主机 Y 通信，IP 数据报的源地址是 10.1.0.1，目的地址是 10.2.0.3

- 数据报先发送到与互联网相连的路由器 R1
  - R1 对内部数据进行加密，
  - 然后重新加上数据报的首部，源地址是路由器 R1 的全球地址 125.1.2.3，目的地址是路由器 R2 的全球地址 194.4.5.6
- 路由器 R2 收到数据报后将数据部分进行解密，恢复原来的数据报，此时目的地址为 10.2.0.3，就交付给 Y。

所以X到Y的通信，实际上是通过了公用的因特网，但在效果上就好像是在本部门的专用网上传送一样

<img src="pic/VPN.jpg" style="zoom:80%;" >

## 3.8 网络地址转换NAT

背景：专用网内部的主机使用本地 IP 地址又想和互联网上的主机通信时，可以使用 NAT 来**将本地 IP 转换为全球 IP**——目前用的最多的扩展IP地址的途径（实际上是重用全球IP）

装有NAT软件的路由器叫做NAT路由器，**它至少有一个有效的外部全球IP地址**。这样，所有使用本地地址的主机在和外界通信时，都要在NAT路由器上将其本地地址转换成全球IP地址，才能和因特网连接。

NAT路由器工作流程：

- 发送数据报：IP数据报的源IP地址192.168.0.3，转换为新的源IP地址（**即NAT路由器的全球IP地址**）172.38.1.5，然后转发出去
- 接收数据报：通过NAT地址转换表，就可把IP数据报上的旧的目的IP地址172.38.1.5，转换为新的目的IP地址192.168.0.3（主机A真正的本地IP地址）

在以前，NAT 将本地 IP 和全球 IP 一一对应，这种方式下拥有 n 个全球 IP 地址的专用网内最多只可以同时有 n 台主机接入互联网。那么该专用网的主机可以轮流使用该n个全球IP地址。

为了更有效地利用全球 IP 地址，现在常用的 NAT 转换表把**传输层的端口号也用上了**，使得多个专用网内部的主机共用一个全球 IP 地址。使用端口号的 NAT 也叫做网络地址与端口转换 NAPT。

<img src="pic/NAPT.png" style="zoom:80%;" >

（NAPT把专用网内不同的**源IP地址，都转换为同样的全球IP地址**。但对源主机所采用的**TCP端口号（不管相同或不同），则转换为不同的新的端口号**。因此，当NAPT路由器收到从因特网发来的应答时，就可以从IP数据报的数据部分找出运输层的端口号，然后根据不同的目的端口号，从NAPT转换表中找到正确的目的主机。）——加上port，为了能够正确找到接收应答的主机



## 3.9 网络层设备——路由器

### 1. 路由器结构

路由器是一种具有多个输入端口和多个输出端口的**专用计算机**，从路由器某个输入端口收到的分组，把该分组从路由器的某个合适的输出端口转发给下一跳路由器。

路由器的转发分组正是网络层的主要工作。

路由器从功能上可以划分为：

- **路由选择**：控制部分，核心构件是路由选择处理机，主要任务：根据所选定的路由选择协议**构造出路由表**

- **分组转发**：交换结构、一组输入端口和一组输出端口

  - 交换结构：根据转发表对分组进行处理，将某个输入的分组找到合适的端口发送出去

    （交换结构可看成是“在路由器中的网络”）

注意，转发和选择有差别，转发是发出去，涉及到一个路由表；而选择，是涉及到多个路由器，主要就是路由表

<img src="pic/router.jpg"  >

路由表：**每个主机都有**（主机在发送每一个IP数据报时都要查找自己的路由表），若按目的主机号来制作路由表，则所得出的路由表就会过于庞大。在路由表中，对每一条的主要信息是：**（目的IP地址，下一跳IP地址）**（在分类网络中）；（目的网络地址、子网掩码和下一跳地址）（在子网划分网络中）

那么路由器也是有路由表的。

### 2. 路由器分组转发流程

在互联网上转发分组时，**是从一个路由器转发到下一个路由器**

问题提出：IP数据报的首部规定是源IP地址，和目的IP地址，那么该如何**通过目的IP地址找到一下跳路由器**呢？

分组转发算法：

- 从数据报的首部提取目的主机的 IP 地址 D，得到**目的网络地址 N**。
- 若 N 就是与此路由器直接相连的某个网络地址，则进行**直接交付**，直接把数据报交付目的主机（当然还需要，数据报封装为MAC帧，再发送此帧）；
- 若不是直接相连，若路由表中有目的地址为 D 的特定主机路由，则把数据报传送给表中所指明的下一跳路由器，是间接交付；
- 若没有特定路由，那么若路由表中有到达网络 N 的路由，则把数据报传送给路由表中所指明的下一跳路由器；
- 若没有找到下一跳路由，若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；
- 都没有找到，报告转发分组出错。

（**特定主机路由**：对特定的目的主机指明一个路由。用处：使网络管理人员能更方便地控制网络和测试网络，同时也可在需要考虑某种安全问题时采用这种特定主机路由）

（**默认路由**：当找不到其他适合的路由的时候，就用它。减少路由表所占用的空间和搜索路由表所用的时间，在一个网络只有很少的对外连接时是很有用的）

## 3.10 IP多播

### 1. 概念

为了一对多的通信

源地址只需发送一次。路由器R1在转发分组时，需要把收到的分组复制成n个副本，然后发送出去。当分组到达目的局域网时，由于**局域网具有硬件多播功能**，因此不需要复制分组，在局域网上的多播组成员都能收到这个。

<img src="pic/multi_broadcast.jpg" style="zoom:80%;" >

能够运行多播协议的路由器称为多播路由器

多播数据报的目的地址：是D类地址——**多播地址只能用于目的地址，而不能用于源地址**

### 2. IGMP & 多播路由选择协议

IGMP协议是让连接在本地局域网上的多播路由器知道本局域网上是否有主机参加或退出了某个多播组。

IGMP的工作：

- 当某个主机加入新的多播组时，该主机应向多播组的多播地址发送一个IGMP报文，声明自己要成为该组的成员。本地的多播路由器收到IGMP报文后，还要利用多播路由选择协议把这种组成员关系转发给因特网上的其他多播路由器
- 组成员关系是动态的。本地多播路由器要周期性地探询本地局域网上的主机，以便知道这些主机是否还继续是组的成员。**只要有一个主机对某个组响应，那么多播路由器就认为这个组是活跃的**。但一个组在经过几次的探询后仍然没有一个主机响应，多播路由器就认为本网络上的主机已经都离开了这个组，因此也就不再把这个组的成员关系转发给其他的多播路由器。



# 4. 传输层

网络层只把分组发送到目的主机，但是真正通信的并不是主机而是主机中的进程。传输层提供了**进程间的逻辑通信**，传输层向高层用户屏蔽了下面网络层的核心细节，使应用程序看起来像是在两个传输层实体之间有一条端到端的逻辑通信信道。

(1) 运输层为相互通信的应用进程提供逻辑通信。(2) 端口和套接字的意义。(3) 无连接的UDP的特点。(4) 面向连接的TCP的特点。(5) 在不可靠的网络上实现可靠传输的工作原理，停止等待协议和ARQ协议。(6) TCP的滑动窗口、流量控制、拥塞控制和连接管理。

## UDP 和 TCP 的特点

- 用户数据报协议 UDP（User Datagram Protocol）是无连接的，尽最大可能交付，没有拥塞控制，面向报文（对于应用程序传下来的报文不合并也不拆分，只是添加 UDP 首部），支持一对一、一对多、多对一和多对多的交互通信。
- 传输控制协议 TCP（Transmission Control Protocol）是面向连接的，提供可靠交付，有流量控制，拥塞控制，提供全双工通信，面向字节流（把应用层传下来的报文看成字节流，把字节流组织成大小不等的数据块），每一条 TCP 连接只能是点对点的（一对一）。

## UDP 首部格式



首部字段只有 8 个字节，包括源端口、目的端口、长度、检验和。12 字节的伪首部是为了计算检验和临时添加的。

## TCP 首部格式



- **序号** ：用于对字节流进行编号，例如序号为 301，表示第一个字节的编号为 301，如果携带的数据长度为 100 字节，那么下一个报文段的序号应为 401。
- **确认号** ：期望收到的下一个报文段的序号。例如 B 正确收到 A 发送来的一个报文段，序号为 501，携带的数据长度为 200 字节，因此 B 期望下一个报文段的序号为 701，B 发送给 A 的确认报文段中确认号就为 701。
- **数据偏移** ：指的是数据部分距离报文段起始处的偏移量，实际上指的是首部的长度。
- **确认 ACK** ：当 ACK=1 时确认号字段有效，否则无效。TCP 规定，在连接建立后所有传送的报文段都必须把 ACK 置 1。
- **同步 SYN** ：在连接建立时用来同步序号。当 SYN=1，ACK=0 时表示这是一个连接请求报文段。若对方同意建立连接，则响应报文中 SYN=1，ACK=1。
- **终止 FIN** ：用来释放一个连接，当 FIN=1 时，表示此报文段的发送方的数据已发送完毕，并要求释放连接。
- **窗口** ：窗口值作为接收方让发送方设置其发送窗口的依据。之所以要有这个限制，是因为接收方的数据缓存空间是有限的。

## TCP 的三次握手



假设 A 为客户端，B 为服务器端。

- 首先 B 处于 LISTEN（监听）状态，等待客户的连接请求。
- A 向 B 发送连接请求报文，SYN=1，ACK=0，选择一个初始的序号 x。
- B 收到连接请求报文，如果同意建立连接，则向 A 发送连接确认报文，SYN=1，ACK=1，确认号为 x+1，同时也选择一个初始的序号 y。
- A 收到 B 的连接确认报文后，还要向 B 发出确认，确认号为 y+1，序号为 x+1。
- B 收到 A 的确认后，连接建立。

**三次握手的原因**

第三次握手是为了防止失效的连接请求到达服务器，让服务器错误打开连接。

客户端发送的连接请求如果在网络中滞留，那么就会隔很长一段时间才能收到服务器端发回的连接确认。客户端等待一个超时重传时间之后，就会重新请求连接。但是这个滞留的连接请求最后还是会到达服务器，如果不进行三次握手，那么服务器就会打开两个连接。如果有第三次握手，客户端会忽略服务器之后发送的对滞留连接请求的连接确认，不进行第三次握手，因此就不会再次打开连接。

## TCP 的四次挥手



以下描述不讨论序号和确认号，因为序号和确认号的规则比较简单。并且不讨论 ACK，因为 ACK 在连接建立之后都为 1。

- A 发送连接释放报文，FIN=1。
- B 收到之后发出确认，此时 TCP 属于半关闭状态，B 能向 A 发送数据但是 A 不能向 B 发送数据。
- 当 B 不再需要连接时，发送连接释放报文，FIN=1。
- A 收到后发出确认，进入 TIME-WAIT 状态，等待 2 MSL（最大报文存活时间）后释放连接。
- B 收到 A 的确认后释放连接。

**四次挥手的原因**

客户端发送了 FIN 连接释放报文之后，服务器收到了这个报文，就进入了 CLOSE-WAIT 状态。这个状态是为了让服务器端发送还未传送完毕的数据，传送完毕之后，服务器会发送 FIN 连接释放报文。

**TIME_WAIT**

客户端接收到服务器端的 FIN 报文后进入此状态，此时并不是直接进入 CLOSED 状态，还需要等待一个时间计时器设置的时间 2MSL。这么做有两个理由：

- 确保最后一个确认报文能够到达。如果 B 没收到 A 发送来的确认报文，那么就会重新发送连接释放请求报文，A 等待一段时间就是为了处理这种情况的发生。
- 等待一段时间是为了让本连接持续时间内所产生的所有报文都从网络中消失，使得下一个新的连接不会出现旧的连接请求报文。

## TCP 可靠传输

TCP 使用超时重传来实现可靠传输：如果一个已经发送的报文段在超时时间内没有收到确认，那么就重传这个报文段。

一个报文段从发送再到接收到确认所经过的时间称为往返时间 RTT，加权平均往返时间 RTTs 计算如下：


其中，0 ≤ a ＜ 1，RTTs 随着 a 的增加更容易受到 RTT 的影响。

超时时间 RTO 应该略大于 RTTs，TCP 使用的超时时间计算如下：


其中 RTTd 为偏差的加权平均值。

## TCP 滑动窗口

窗口是缓存的一部分，用来暂时存放字节流。发送方和接收方各有一个窗口，接收方通过 TCP 报文段中的窗口字段告诉发送方自己的窗口大小，发送方根据这个值和其它信息设置自己的窗口大小。

发送窗口内的字节都允许被发送，接收窗口内的字节都允许被接收。如果发送窗口左部的字节已经发送并且收到了确认，那么就将发送窗口向右滑动一定距离，直到左部第一个字节不是已发送并且已确认的状态；接收窗口的滑动类似，接收窗口左部字节已经发送确认并交付主机，就向右滑动接收窗口。

接收窗口只会对窗口内最后一个按序到达的字节进行确认，例如接收窗口已经收到的字节为 {31, 34, 35}，其中 {31} 按序到达，而 {34, 35} 就不是，因此只对字节 31 进行确认。发送方得到一个字节的确认之后，就知道这个字节之前的所有字节都已经被接收。



## TCP 流量控制

流量控制是为了控制发送方发送速率，保证接收方来得及接收。

接收方发送的确认报文中的窗口字段可以用来控制发送方窗口大小，从而影响发送方的发送速率。将窗口字段设置为 0，则发送方不能发送数据。

## TCP 拥塞控制

如果网络出现拥塞，分组将会丢失，此时发送方会继续重传，从而导致网络拥塞程度更高。因此当出现拥塞时，应当控制发送方的速率。这一点和流量控制很像，但是出发点不同。流量控制是为了让接收方能来得及接收，而拥塞控制是为了降低整个网络的拥塞程度。



TCP 主要通过四个算法来进行拥塞控制：慢开始、拥塞避免、快重传、快恢复。

发送方需要维护一个叫做拥塞窗口（cwnd）的状态变量，注意拥塞窗口与发送方窗口的区别：拥塞窗口只是一个状态变量，实际决定发送方能发送多少数据的是发送方窗口。

为了便于讨论，做如下假设：

- 接收方有足够大的接收缓存，因此不会发生流量控制；
- 虽然 TCP 的窗口基于字节，但是这里设窗口的大小单位为报文段。



### 1. 慢开始与拥塞避免

发送的最初执行慢开始，令 cwnd = 1，发送方只能发送 1 个报文段；当收到确认后，将 cwnd 加倍，因此之后发送方能够发送的报文段数量为：2、4、8 ...

注意到慢开始每个轮次都将 cwnd 加倍，这样会让 cwnd 增长速度非常快，从而使得发送方发送的速度增长速度过快，网络拥塞的可能性也就更高。设置一个慢开始门限 ssthresh，当 cwnd >= ssthresh 时，进入拥塞避免，每个轮次只将 cwnd 加 1。

如果出现了超时，则令 ssthresh = cwnd / 2，然后重新执行慢开始。

### 2. 快重传与快恢复

在接收方，要求每次接收到报文段都应该对最后一个已收到的有序报文段进行确认。例如已经接收到 M1 和 M2，此时收到 M4，应当发送对 M2 的确认。

在发送方，如果收到三个重复确认，那么可以知道下一个报文段丢失，此时执行快重传，立即重传下一个报文段。例如收到三个 M2，则 M3 丢失，立即重传 M3。

在这种情况下，只是丢失个别报文段，而不是网络拥塞。因此执行快恢复，令 ssthresh = cwnd / 2 ，cwnd = ssthresh，注意到此时直接进入拥塞避免。

慢开始和快恢复的快慢指的是 cwnd 的设定值，而不是 cwnd 的增长速率。慢开始 cwnd 设定为 1，而快恢复 cwnd 设定为 ssthresh。



# 5. 应用层

是最上层的

## 5.1 域名系统

## 5.2 文件传送协议

## 5.3 动态主机配置协议

## 5.4 远程登录协议

## 5.5 电子邮件协议

## 5.6 常用端口

## 5.7 web页面请求的全部过程









## ps：互联网中设备总结

网络互联的背景：网络是变化多样的，由于用户需求不同，所以不能让大家都使用同一个网络，**没有一种单一的网络能够适应所有用户的需求**，所以如何将不同的网络互联起来称为麻烦的事情。

将网络互相连接起来要使用一些**中间设备**：

| 层级       | 中间设备     | 概念                                                         |
| ---------- | ------------ | ------------------------------------------------------------ |
| 物理层     | 转发器       |                                                              |
| 数据链路层 | 网桥、桥接器 |                                                              |
| 网络层     | 路由器       | 由于一个路由器至少应当连接到两个网络，因此一个路由器至少应当有两个不同的IP地址。 |
| 网络层以上 | 网关         |                                                              |

- 用网关连接两个不兼容的系统需要在高层进行协议的转换
- 中间设备是转发器或网桥时，仅仅是把一个网络扩大了，而不算是网络互联，因为它们有同样的网络号；而路由器连接了两个网络，才算是网络互联
- 当一个主机同时连接到两个网络上时，该主机就必须同时具有两个相应的IP地址，其网络号必须是不同的。这种主机称为**多归属主机**(multihomed host)。
- 路由器只根据目的站的IP地址的网络号进行路由选择，而不会关注源IP地址（没有意义）
- 网络适配器决定了MAC地址